###############################################
### Analise dos dados de sapos urbanos ########
### Dissertacao do Paulo Mateus Cruz Santos ###
###############################################

# Define a area de trabalho
setwd("C:/Users/anderson/OneDrive/Documents/Pesquisa/Paulo")

# Limpa a area de trabalho
remove(list = ls())

# Desabilita a notacao cientifica
options(scipen = 999)

# Carrega os pacotes
library(vegan)
library(stringr)
library(plyr)
library(ggplot2)


#####################################
### IMPORTA OS DADOS DAS ESPECIES ###
#####################################

# Adenomera andreae
A_andreae = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/A_andreae_ALL.csv")

# Allobates femoralis
A_femoralis = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/A_femoralis_ALL.csv")

# Ameerega hahneli (vazio)
A_hahneli = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/A_hahneli_ALL2.csv")

# Adenomera hylaedactyla
A_hylaedactyla = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/A_hylaedactyla___.csv")

# Amazophrynella manaos
A_manaos = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/A_manaos_ALL.csv")
A_manaos$species[A_manaos$species == "Amazophrynella minuta"] = "Amazophrynella manaos" # atualiza o nome da especie

# Allobates paleovarzensis
A_paleovarzensis = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/A_paleovarzensis_ALL__.csv")

# Atelopus spumarius
A_spumarius = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/A_spumarius_ALL.csv")

# Anomaloglossus stepheni
A_stepheni = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/A_stepheni.csv")

# Allobates sumtuosus
A_sumtuosus = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/A_sumtuosus_ALL_7.csv")

# Ameerega trivittata
A_trivittata = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/A_trivittata_ALL.csv")

# Chiasmocleis shudikarensis
C_shudikarensis = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/C_shudikarensis_ALL_.csv")

# Dendropsophus minutus
D_minutus = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/D_minutus_ALL.csv")

# Elachistocleis bicolor
E_bicolor = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/E_bicolor_ALL.csv")

# Leptodactylus petersii
L_petersii = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/L_petersii_ALL.csv")

# Leptodactylus stenodema
L_stenodema = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/L_stenodema_ALL_teste.csv")

# Pristimantis fenestratus
P_fenestratus = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/P_fenestratus_ALL.csv")

# Rhinella proboscidea
R_proboscidea = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/R_proboscidea_ALL____.csv")

# Synapturanus mirandaribeiroi
S_mirandaribeiroi = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/S_mirandaribeiroi_m1.csv")

# Synapturanus salseri
S_salseri = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/S_salseri_ALL.csv")


# JUNTA OS DADOS BRUTOS DAS ESPECIES
# Ameerega hahneli nao aparece, porque nao foi detectada pelo Pattern Matching (Arbimon)
frogs_raw = rbind(A_andreae,
                  A_femoralis,
                  A_hahneli,
                  A_hylaedactyla,
                  A_manaos,
                  A_paleovarzensis,
                  A_spumarius,
                  A_stepheni,
                  A_sumtuosus,
                  A_trivittata,
                  C_shudikarensis,
                  D_minutus,
                  E_bicolor,
                  L_petersii,
                  L_stenodema,
                  P_fenestratus,
                  R_proboscidea,
                  S_mirandaribeiroi,
                  S_salseri)

# Das 19 especies investigadas, 18 foram detectadas pelo Pattern Matching (Arbimon)
sort(unique(frogs_raw$species))

# Das 18 especies detectadas pelo Pattern Matching (Arbimon), 13 foram validadas (TRUE POSITIVES)
sort(unique(subset(frogs_raw, validated == "present")$species))

# O nome de todas as especies esta correto, conforme a lista de Frost (acesso em 2023-04-06)
# https://amphibiansoftheworld.amnh.org/content/search?subtree=&subtree_id=&country%5B%5D=194&search_type=count


# Ha 69319 gravacoes na playlist TUDO
# Conferir se esse numero vai bater com os arquivos que receberei do Arbimon


###################################
### IMPORTA OS DADOS DOS SITIOS ###
###################################

# Sitios (conforme Arbimon)
sites = read.csv("https://raw.githubusercontent.com/buenoas/urban_frogs/main/sites-export.csv")

# Remove os sitios "Fonte" e "frogs"
sites = sites[-which(sites$Name == c("Fonte", "frogs")), ]

# Renumera as linhas
rownames(sites) = NULL


#########################
### ANALISE DOS DADOS ###
#########################

# Mantem apenas as deteccoes validadas
x_sub = subset(frogs_raw, validated == "present")

# Cria uma coluna em que cada linha eh um registro de ocorrencia
x_sub$occurrence = 1

# Cria uma matriz de abundancia de sitios x especies
df_ab = as.data.frame(
  tapply(x_sub$occurrence,
         list(x_sub$site, x_sub$species),
         sum))

# Converte NA em zero
df_ab[is.na(df_ab)] = 0

# Faz uma analise de ordenacao multivariada (PCoA)
# Padroniza os dados
frogs.std = df_ab/rowSums(df_ab) # dados de abundancia relativa
#frogs.std = decostand(df_ab, method = "pa") # dados de presence-absencia

# Calcula a distancia de Bray-Curtis entre os sitios
bray = vegdist(frogs.std, method = "bray")

# PCoA
pcoa = cmdscale(bray, k = 2, eig = TRUE, add = TRUE)

# Extrai os valores dos 2 primeiros eixos da PCoA
positions = as.data.frame(pcoa$points)

# Renomeia as colunas
colnames(positions) = c("PCo1", "PCo2")

# Adiciona o codigo do municipio
positions$city_code = word(rownames(positions), 1, sep = "_")

# Adiciona o nome do municipio
positions$city_name = positions$city_code
positions$city_name[positions$city_name == "IR"] = "Iranduba"
positions$city_name[positions$city_name == "IT"] = "Itacoatiara"
positions$city_name[positions$city_name == "MC"] = "Manacapuru"
positions$city_name[positions$city_name == "MA"] = "Manaus"
positions$city_name[positions$city_name == "PF"] = "Presidente Figueiredo"
positions$city_name[positions$city_name == "RPE"] = "Rio Preto da Eva"

# Porcentagem de explicacao dos eixos
percentage_explained = 100 * pcoa$eig / sum(pcoa$eig)

# Poligonos do grafico
find_hull = function(positions) positions[chull(positions$PCo1, positions$PCo2), ]
hulls = ddply(positions, "city_name", find_hull)

# Produz o grafico com os 2 primeiros eixos da PCoA
gg_pcoa = 
  
  ggplot(data = positions[order(positions$PCo1, positions$PCo2), ],
         aes(x = PCo1, y = PCo2,
             colour = city_name, fill = city_name)) + 
  
  labs(x = paste0("PCo 1 ", "(", round(percentage_explained[1]), "%)"),
       y = paste0("PCo 2 ", "(", round(percentage_explained[2]), "%)"),
       colour = NULL,
       fill = NULL,
       title = "Diurnal frogs in six Amazonian cities",
       subtitle = "Passive acoustic monitoring data") +
  
  scale_colour_brewer(type = "qual", palette = "Set1") +
  scale_fill_brewer(type = "qual", palette = "Set1") +
  
  geom_polygon(data = hulls, aes(colour = NULL),
               alpha = 0.2, show.legend = FALSE) +
  
  geom_point(size = 4, shape = 21, colour = "black", alpha = 0.6) +
  
  theme_classic(base_size = 12) +
  theme(axis.title = element_text(colour = "black"),
        axis.text = element_text(colour = "black"),
        axis.ticks = element_line(colour = "black"),
        axis.line = element_line(colour = "black"),
        legend.position = "bottom")

# Visualiza o grafico
gg_pcoa

# Salva o grafico
ggsave(gg_pcoa, filename = "pcoa.png", dpi = 600,
       width = 15, height = 15, units = "cm")


# Grafico da ocorrencia das especies nos sitios
# Prepara os dados
# Numero de sitios ocupados por cada especies
sites_occ = data.frame(
  freq = sort(colSums(ifelse(df_ab > 0, 1, 0))))

# Ordena as especies com base no numero de sitios ocupados
sites_occ$species = factor(rownames(sites_occ),
                           levels = rownames(sites_occ))

# Remove o nome das linhas
rownames(sites_occ) = NULL

# Reordena as colunas
sites_occ = sites_occ[, 2:1]

# Produz o grafico
gg_occ = 
  
  ggplot(data = sites_occ,
         aes(x = freq/36 * 100, y = species)) + 
  
  labs(x = "Sites occupied (%)",
       y = NULL,
       title = "Diurnal frogs distribution in 36 sites",
       subtitle = "Passive acoustic monitoring data") +
  
  geom_col(fill = "darkgreen", width = 0.8) + 
  
  theme_minimal(base_size = 12) +
  theme(axis.title.x = element_text(colour = "black"),
        axis.text.x = element_text(colour = "black"),
        axis.text.y = element_text(colour = "black", face = "italic"),
        axis.ticks = element_blank())

# Visualiza o grafico
gg_occ

# Salva o grafico
ggsave(gg_occ, filename = "occurrence.jpg", dpi = 600,
       width = 20, height = 15, units = "cm")
